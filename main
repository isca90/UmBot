# bot.py
import os
import random
import discord
from datetime import datetime
from keep_alive import keep_alive
from dotenv import load_dotenv
from discord.ext import tasks,commands
import pytz
from discord.utils import get
import func as f

load_dotenv()

TOKEN = os.getenv('DISCORD_TOKEN')
client = discord.Client()
intents = discord.Intents.default()
intents.members = True
client = commands.Bot(command_prefix=',', case_insensitive=True, intents=intents)
logtime=datetime.now(pytz.timezone("Europe/London"))
time = logtime.strftime("%H:%M")


@client.event
async def on_ready():
  print(f'{client.user.name} has connected to Discord!')
  mytask.start()
  channel = client.get_channel(993605157248041081)
  await channel.send("erase me")
  await channel.send("up: "+time)


@client.event
async def on_member_join(member):
    channel = client.get_channel(993684488410386563)
    roleNewPplo=get(member.guild.roles, id=994449061052698624)
    await member.add_roles(roleNewPplo)
    await channel.send(f"""
______________________________________________________________
Olá {member.display_name}! 
Para teres acesso ao canal por favor lê com atenção as regras abaixo
Regra random1 -- basdpqwodkas
Regra random2 -- basdpqwodkas
Regra random3 -- basdpqwodkas
Regra random4 -- para saber os comandos bot escreve !ajuda ou !dm
______________________________________________________________
Se concordas reage com 👍
                       """)

@client.event
async def on_reaction_add(reaction, member):
    channel = client.get_channel(993684488410386563)
    roleAfter=get(member.guild.roles, id=994352546204373032)
    if member.guild.roles==994449061052698624:
        await member.add_roles(roleAfter)
        await channel.send('Ai olha para mim, sou o '+{member.mention})


@client.event
async def on_member_remove(member):
    channel = client.get_channel(993684543041191966) 
    await channel.send(f'Tenho de abandonar que tenho uma consulta às cinco - diz  {member.mention}')

  
@client.event
async def on_message(message):
    if message.author == client.user:
        return

    if message.content == '!frase':
        fraseAMostrar=f.MostrarFraseRandom()
        now = datetime.now()
        current_time = now.strftime("%H:%M:%S")   
        emoji = '\N{PACKAGE}'      
        await message.add_reaction(emoji)        
        await message.channel.send((fraseAMostrar[5:]).capitalize())
        print(current_time+"->"+" "+fraseAMostrar)
    
    elif "boa n" in message.content.lower():
        await message.channel.send("Boa noite o &$%")  

    elif "bot" in message.content.lower():
        await message.channel.send("Eu?")

    elif "!roast" in message.content.lower(): 
        channel = client.get_channel(992825262205046918) 
        await channel.purge(limit=1)
        roast=f.MostrarRandomRoast()
        if message.mentions:
          userx=message.mentions[0].id
          userMentioned = await client.fetch_user(userx)          
          await message.channel.send("Ai aiiii!! "+message.author.display_name+" disse:'"+roast+"' "+userMentioned.mention)
        else:
          await message.channel.send(message.author.mention+" "+roast)
    
    elif "!elogio" in message.content.lower(): 
        channel = client.get_channel(992825262205046918) 
        await channel.purge(limit=1)
        elogio=f.MostrarRandomElogio()
        if message.mentions:
            userx=message.mentions[0].id
            userMentioned = await client.fetch_user(userx)
            await message.channel.send("Ai aiiii!! "+message.author.display_name+" disse:'"+elogio+"' "+userMentioned.mention)
        else:  
            await message.channel.send(message.author.mention+" "+elogio)
    
    elif "!dm" in message.content.lower():
        dmMessage=f.MostrarFraseDM
        await message.author.send(dmMessage)
    
    elif "!sugestao" in message.content.lower():
        channeltosend = client.get_channel(994404469389414500)
        channeltoerase = client.get_channel(992825262205046918)
        await channeltosend.send(message.content)
        await channeltoerase.purge(limit=1)

    elif "!ajuda" in message.content.lower():
        ajuda= f.MostrarFraseAjuda()
        await message.author.send(ajuda)
    
    elif "!ditado" in message.content.lower():
        channeltoerase = client.get_channel(992825262205046918)
        ditado=f.MostrarRandomDitado()
        await channeltoerase.purge(limit=1)  
        await message.channel.send(ditado)
      
    elif "!bomdia" in message.content.lower():
        channeltoerase = client.get_channel(992825262205046918)
        bomdia=f.MostrarRespostaBomDia()
        await channeltoerase.purge(limit=1)  
        await message.channel.send(bomdia)

@tasks.loop(seconds=300)
async def mytask():
  channel = client.get_channel(993605157248041081)
  logtime2=datetime.now(pytz.timezone("Europe/London"))
  time2 = logtime2.strftime("%H:%M")
  await channel.purge(limit=1)
  
  await channel.send(". "+time2)
  
  x=random.choice(range(0,2))
  if x==0:
      estadobot=f.MostrarEstadoBot()
      await client.change_presence(activity=discord.Activity(type=discord.ActivityType.watching, name=estadobot))
  elif x==1:
      estadobot=f.MostrarEstadoBot()
      await client.change_presence(activity=discord.Activity(type=discord.ActivityType.listening, name=estadobot))
  else:
      estadobot=f.MostrarEstadoBot()
      await client.change_presence(activity=discord.Game(estadobot))

      
keep_alive()
client.run(TOKEN)
